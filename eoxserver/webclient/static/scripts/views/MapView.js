define(["backbone","communicator","globals","openlayers","models/MapModel","filesaver"],function(a,b,c){var d=a.View.extend({onShow:function(){this.ol_baseLayers={},this.ol_products={},this.ol_overlays={},this.geojson_format=new ol.format.GeoJSON,this.map=new ol.Map({renderer:"canvas",target:"map",view:new ol.View2D({center:[9,45],zoom:6,projection:ol.proj.get("EPSG:4326")})}),console.log("Created Map"),this.map.on("moveend",function(a){var c=a.map.getView(),d=c.getCenter();b.mediator.trigger("router:setUrl",{x:d[0],y:d[1],l:c.getZoom()})}),this.listenTo(b.mediator,"map:center",this.centerMap),this.listenTo(b.mediator,"map:layer:change",this.changeLayer),this.listenTo(b.mediator,"productCollection:sortUpdated",this.onSortProducts),this.listenTo(b.mediator,"productCollection:updateOpacity",this.onUpdateOpacity),this.listenTo(b.mediator,"selection:activated",this.onSelectionActivated),this.listenTo(b.mediator,"map:load:geojson",this.onLoadGeoJSON),this.listenTo(b.mediator,"map:export:geojson",this.onExportGeoJSON),this.listenTo(b.mediator,"time:change",this.onTimeChange),b.reqres.setHandler("get:selection:json",_.bind(this.onGetGeoJSON,this));var a=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})});return this.source=new ol.source.Vector,this.source.on("change",this.onDone),this.vector=new ol.layer.Vector({source:this.source,style:a}),this.boxstart=void 0,this.drawControls={pointSelection:new ol.interaction.Draw({source:this.source,type:"Point"}),lineSelection:new ol.interaction.Draw({source:this.source,type:"LineString"}),polygonSelection:new ol.interaction.Draw({source:this.source,type:"Polygon"}),bboxSelection:new ol.interaction.DragBox({style:a})},this.drawControls.bboxSelection.on("boxstart",function(a){this.boxstart=a.getCoordinate()},this),this.drawControls.bboxSelection.on("boxend",function(a){var b=a.getCoordinate(),c=new ol.geom.Polygon([[[this.boxstart[0],this.boxstart[1]],[this.boxstart[0],b[1]],[b[0],b[1]],[b[0],this.boxstart[1]]]]),d=new ol.Feature;d.setGeometry(c),this.source.addFeature(d)},this),c.baseLayers.each(function(a){var b=this.createLayer(a);this.ol_baseLayers[a.get("view").id]=b,this.map.addLayer(b)},this),c.products.each(function(a){var b=this.createLayer(a);this.ol_products[a.get("view").id]=b,this.map.addLayer(b)},this),c.overlays.each(function(a){var b=this.createLayer(a);this.ol_overlays[a.get("view").id]=b,this.map.addLayer(b)},this),this.onSortProducts(),this.map.addLayer(this.vector),this},createLayer:function(a){for(var b=null,c=a.get("view"),d=ol.proj.get("EPSG:4326"),e=d.getExtent(),f=ol.extent.getWidth(e)/256,g=new Array(18),h=new Array(18),i=0;18>i;++i)g[i]=f/Math.pow(2,i+1),h[i]=i;switch(c.protocol){case"WMTS":b=new ol.layer.Tile({visible:c.visible,source:new ol.source.WMTS({urls:c.urls,layer:c.id,matrixSet:c.matrixSet,format:c.format,projection:c.projection,tileGrid:new ol.tilegrid.WMTS({origin:ol.extent.getTopLeft(e),resolutions:g,matrixIds:h}),style:c.style})});break;case"WMS":b=new ol.layer.Tile({visible:a.get("visible"),source:new ol.source.TileWMS({crossOrigin:"anonymous",params:{LAYERS:c.id,VERSION:"1.1.0",FORMAT:"image/png"},url:c.urls[0]})})}return b},centerMap:function(a){console.log(a),this.map.getView().setCenter([parseFloat(a.x),parseFloat(a.y)]),this.map.getView().setZoom(parseInt(a.l))},changeLayer:function(a){if(a.isBaseLayer)c.baseLayers.forEach(function(a){a.set("visible",!1)}),$.each(this.ol_baseLayers,function(a,b){b.setVisible(!1)}),c.baseLayers.find(function(b){return b.get("view").id==a.id}).set("visible",!0),this.ol_baseLayers[a.id].setVisible(!0);else{var b=c.products.find(function(b){return b.get("view").id==a.id});b?(b.set("visible",a.visible),this.ol_products[a.id].setVisible(a.visible)):(c.overlays.find(function(b){return b.get("view").id==a.id}).set("visible",a.visible),this.ol_overlays[a.id].setVisible(a.visible))}},onSortProducts:function(){var a=this;$.each(this.ol_products,function(b,c){a.map.removeLayer(c)},a),$.each(this.ol_overlays,function(b,c){a.map.removeLayer(c)},a),_.each(c.products.last(c.products.length).reverse(),function(a){this.map.addLayer(this.ol_products[a.get("view").id])},this),_.each(c.overlays.last(c.overlays.length).reverse(),function(a){this.map.addLayer(this.ol_overlays[a.get("view").id])},this),console.log("Map products sorted")},onUpdateOpacity:function(a){this.ol_products[a.model.get("view").id].setOpacity(a.value)},onSelectionActivated:function(a){if(a.active)for(key in this.drawControls){var c=this.drawControls[key];if(a.id==key)this.map.addInteraction(c);else{this.map.removeInteraction(c);var d=this.source.getAllFeatures();for(var e in d)this.source.removeFeature(d[e]);b.mediator.trigger("selection:changed",null)}}else for(key in this.drawControls){var c=this.drawControls[key];this.map.removeInteraction(c);var d=this.source.getAllFeatures();for(var e in d)this.source.removeFeature(d[e]);b.mediator.trigger("selection:changed",null)}},onLoadGeoJSON:function(a){var b=this.source.getAllFeatures();for(var c in b)this.source.removeFeature(b[c]);var d,e=new ol.source.GeoJSON({object:a}),f=e.getAllFeatures();if(f){for(var c=0;c<f.length;++c)d?d.extend(f[c].getGeometry().getExtent()):d=f[c].getGeometry().getExtent();this.source.addFeatures(f),this.map.getView().fitExtent(d,this.map.getSize())}},onExportGeoJSON:function(){var a,b=this.vector.getSource().getAllFeatures(),c=JSON.stringify(this.geojson_format.writeFeatures(b)),a=new Blob([c],{type:"text/plain;charset=utf-8"});saveAs(a,"selection.geojson")},onGetGeoJSON:function(){var a=this.vector.getSource().getAllFeatures(),b=this.geojson_format.writeFeatures(a);return b},onDone:function(a){var c=a.target.getAllFeatures().pop(),d=null;c&&(d=c.getGeometry()),b.mediator.trigger("selection:changed",d)},onTimeChange:function(a){var b=getISODateTimeString(a.start)+"/"+getISODateTimeString(a.end);$.each(this.ol_products,function(a,b){b.getSource().getParams()}),c.products.each(function(a){if(a.get("timeSlider")){var c=this.ol_products[a.get("view").id].getSource().getParams();c.TIME=b,this.ol_products[a.get("view").id].getSource().updateParams(c)}},this)}});return{MapView:d}});
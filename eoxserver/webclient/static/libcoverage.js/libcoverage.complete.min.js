var namespace=function(c,b,a){var c=c.split(b||"."),a=a||window,d,b=0;for(d=c.length;b<d;b++)a=a[c[b]]=a[c[b]]||{};return a};namespace("WCS.Core");
WCS.Util=function(){return{objectToKVP:function(c){var b=[],a;for(a in c)b.push(a+"="+c[a]);return b.join("&")},stringToIntArray:function(c,b){return $.map(c.split(b||" "),function(a){return parseInt(a)})},stringToFloatArray:function(c,b){return $.map(c.split(b||" "),function(a){return parseFloat(a)})},deepMerge:function(c,b){if(!("object"!=typeof c||"object"!=typeof b))for(var a in b)c.hasOwnProperty(a)&&"object"==typeof c[a]&&"object"==typeof b[a]?WCS.Util.deepMerge(c[a],b[a]):c[a]=b[a]}}}();
WCS.Core.KVP=function(){return{getCapabilitiesURL:function(c,b,a){if(!c)throw Error("Parameter 'url' is mandatory.");var b=b||{},a=a||{},d=["service=wcs","version=2.0.0","request=getcapabilities"];b.updatesequence&&d.push("updatesequence="+b.updatesequence);b.sections&&d.push("sections="+b.sections.join(","));b=WCS.Util.objectToKVP(a);return c+("?"!==c.charAt(c.length-1)?"?":"")+d.join("&")+(0<b.length?"&"+b:"")},describeCoverageURL:function(c,b,a){if(!c||!b)throw Error("Parameters 'url' and 'coverageids' are mandatory.");
var d=["service=wcs","version=2.0.0","request=describecoverage"],a=a||{};d.push("coverageid="+("string"===typeof b?b:b.join(",")));b=WCS.Util.objectToKVP(a);return c+("?"!==c.charAt(c.length-1)?"?":"")+d.join("&")+(0<b.length?"&"+b:"")},getCoverageURL:function(c,b,a,d){if(!c||!b)throw Error("Parameters 'url' and 'coverageid' are mandatory.");a=a||{};subsetCRS=a.subsetCRS||"http://www.opengis.net/def/crs/EPSG/0/4326";"?"!==c.charAt(c.length-1)&&(c+="?");b=["service=wcs","version=2.0.0","request=getcoverage",
"coverageid="+b];a.format&&b.push("format="+a.format);a.bbox&&(!a.subsetX&&!a.subsetY)&&(a.subsetX=[a.bbox[0],a.bbox[2]],a.subsetY=[a.bbox[1],a.bbox[3]]);a.subsetX&&b.push("subset=x,"+subsetCRS+"("+a.subsetX[0]+","+a.subsetX[1]+")");a.subsetY&&b.push("subset=y,"+subsetCRS+"("+a.subsetY[0]+","+a.subsetY[1]+")");a.size&&(!a.sizeX&&!a.sizeY)&&(a.sizeX=a.size[0],a.sizeY=a.size[1]);a.sizeX&&b.push("size=x("+a.sizeX+")");a.sizeY&&b.push("size=y("+a.sizeY+")");a.resolution&&(!a.resolutionX&&!a.resolutionY)&&
(a.resolutionX=a.resolution[0],a.resolutionY=a.resolution[1]);a.rangeSubset&&b.push("rangesubset="+a.rangeSubset.join(","));a.resolutionX&&b.push("resolution=x("+a.resolutionX+")");a.resolutionY&&b.push("resolution=y("+a.resolutionY+")");a.interpolation&&b.push("interpolation="+a.interpolation);a.outputCRS&&b.push("outputcrs="+a.outputCRS);a.multipart&&b.push("mediatype=multipart/mixed");a=WCS.Util.objectToKVP(d);return c+("?"!==c.charAt(c.length-1)?"?":"")+b.join("&")+(0<a.length?"&"+a:"")}}}();
WCS.Core.Parse=function(){(function(a){a.fn.textArray=function(){return this.map(function(){return a(this).text()}).get()}})(jQuery);var c={};$.xmlns.xlink="http://www.w3.org/1999/xlink";$.xmlns.ows="http://www.opengis.net/ows/2.0";$.xmlns.wcs="http://www.opengis.net/wcs/2.0";$.xmlns.gml="http://www.opengis.net/gml/3.2";$.xmlns.gmlcov="http://www.opengis.net/gmlcov/1.0";$.xmlns.swe="http://www.opengis.net/swe/2.0";$.xmlns.crs="http://www.opengis.net/wcs/service-extension/crs/1.0";var b=function(a,
b){c.hasOwnProperty(a)?c[a].push(b):c[a]=[b]},a=function(a){for(var c in a)b(c,a[c])},d={throwOnException:!1},e=function(a){for(var b=a.find("gml|Envelope"),c=a.find("gml|domainSet"),e=WCS.Util.stringToIntArray(c.find("gml|low").text()),d=WCS.Util.stringToIntArray(c.find("gml|high").text()),h=[],f=0;f<Math.min(e.length,d.length);++f)h.push(d[f]+1-e[f]);var g=[];c.find("gml|offsetVector").each(function(){g.push(WCS.Util.stringToFloatArray($(this).text()))});for(var k=[],f=0;f<g.length;++f)for(var i=
0;i<g.length;++i)0!=g[i][f]&&k.push(g[i][f]);return{coverageId:a.find("wcs|CoverageId").text(),dimensions:parseInt(a.find("gml|RectifiedGrid").attr("dimension")),bounds:{projection:b.attr("srsName"),lower:WCS.Util.stringToFloatArray(b.find("gml|lowerCorner").text()),upper:WCS.Util.stringToFloatArray(b.find("gml|upperCorner").text())},envelope:{low:e,high:d},size:h,origin:WCS.Util.stringToFloatArray(c.find("gml|pos").text()),offsetVectors:g,resolution:k,rangeType:a.find("swe|field").map(function(){var a=
$(this);return{name:a.attr("name"),description:a.find("swe|description").text(),uom:a.find("swe|uom").attr("code"),nilValues:a.find("swe|nilValue").map(function(){var a=$(this);return{value:parseInt(a.text()),reason:a.attr("reason")}}).get(),allowedValues:WCS.Util.stringToIntArray(a.find("swe|interval").text()),significantFigures:parseInt(a.find("swe|significantFigures").text())}}).get(),coverageSubtype:a.find("wcs|CoverageSubtype").text(),supportedCRSs:a.find("wcs|supportedCRS").textArray(),nativeCRS:a.find("wcs|nativeCRS").text(),
supportedFormats:a.find("wcs|supportedFormat").textArray()}};a({Capabilities:function(a){var b=a.find("ows|ServiceIdentification"),c=a.find("ows|ServiceProvider"),e=a.find("wcs|ServiceMetadata");return{serviceIdentification:{title:b.find("ows|Title").text(),"abstract":b.find("ows|Abstract").text(),keywords:b.find("ows|Keyword").textArray(),serviceType:b.find("ows|ServiceType").text(),serviceTypeVersion:b.find("ows|ServiceTypeVersion").text(),profiles:b.find("ows|Profile").textArray(),fees:b.find("ows|Fees").text(),
accessConstraints:b.find("ows|AccessConstraints").text()},serviceProvider:{providerName:c.find("ows|ProviderName").text(),providerSite:c.find("ows|ProviderSite").attr("xlink:href"),individualName:c.find("ows|IndividualName").text(),positionName:c.find("ows|PositionName").text(),contactInfo:{phone:{voice:c.find("ows|Phone ows|Voice").text(),facsimile:c.find("ows|Phone ows|Facsimile").text()},address:{deliveryPoint:c.find("ows|Address ows|DeliveryPoint").text(),city:c.find("ows|Address ows|City").text(),
administrativeArea:c.find("ows|Address ows|AdministrativeArea").text(),postalCode:c.find("ows|Address ows|PostalCode").text(),country:c.find("ows|Address ows|Country").text(),electronicMailAddress:c.find("ows|Address ows|ElectronicMailAddress").text()},onlineResource:c.find("ows|OnlineResource").attr("xlink:href"),hoursOfService:c.find("ows|HoursOfService").text(),contactInstructions:c.find("ows|ContactInstructions").text()},role:c.find("ows|Role").text()},serviceMetadata:{formatsSupported:e.find("wcs|formatSupported").textArray(),
crssSupported:e.find("crs|crsSupported").textArray()},operations:$.makeArray(a.find("ows|OperationsMetadata ows|Operation").map(function(){var a=$(this);return{name:a.attr("name"),getUrl:a.find("ows|Post").attr("xlink:href"),postUrl:a.find("ows|Get").attr("xlink:href")}})),contents:{coverages:a.find("wcs|Contents wcs|CoverageSummary").map(function(){var a=$(this);return{coverageId:a.find("wcs|CoverageId").text(),coverageSubtype:a.find("wcs|CoverageSubtype").text()}}).get()}}},ExceptionReport:function(a){a=
a.find("ows|Exception");a={code:a.attr("exceptionCode"),locator:a.attr("locator"),text:a.find("ows|ExceptionText").text()};if(d.throwOnException)throw new Exception(a.text);return a},CoverageDescriptions:function(a){return{coverageDescriptions:a.find("wcs|CoverageDescription").map(function(){return WCS.Core.Parse.callParseFunctions(this.localName,$(this))}).get()}},CoverageDescription:e,RectifiedGridCoverage:e});return{pushParseFunction:b,pushParseFunctions:a,parse:function(a){a="string"===typeof a?
$.parseXML(a).documentElement:a.documentElement;return WCS.Core.Parse.callParseFunctions(a.localName,$(a))},callParseFunctions:function(a,b){if(c.hasOwnProperty(a)){for(var e=c[a],d={},j=0;j<e.length;++j){var h=e[j](b);WCS.Util.deepMerge(d,h)}return d}throw Error("No parsing function for tag name '"+a+"' registered.");},options:d}}();namespace("WCS.EO");
WCS.EO.KVP=function(){return{describeEOCoverageSetURL:function(c,b,a,d){if(!c||!b)throw Error("Parameters 'url' and 'eoid' are mandatory.");a=a||{};d=d||{};subsetCRS=a.subsetCRS||"http://www.opengis.net/def/crs/EPSG/0/4326";b=["service=wcs","version=2.0.0","request=describeeocoverageset","eoid="+b];a.bbox&&(!a.subsetX&&!a.subsetY)&&(a.subsetX=[a.bbox[0],a.bbox[2]],a.subsetY=[a.bbox[1],a.bbox[3]]);a.subsetX&&b.push("subset=x,"+subsetCRS+"("+a.subsetX[0]+","+a.subsetX[1]+")");a.subsetY&&b.push("subset=y,"+
subsetCRS+"("+a.subsetY[0]+","+a.subsetY[1]+")");a.subsetTime&&b.push('subset=phenomenonTime("'+a.subsetTime[0]+'","'+a.subsetTime[1]+'")');a.containment&&b.push("containment="+a.containment);a.count&&b.push("count="+a.count);a.sections&&b.push("sections="+a.sections.join(","));a=WCS.Util.objectToKVP(d);return c+("?"!==c.charAt(c.length-1)?"?":"")+b.join("&")+(0<a.length?"&"+a:"")}}}();
WCS.EO.Parse=function(){$.xmlns.eop="http://www.opengis.net/eop/2.0";$.xmlns.wcseo="http://www.opengis.net/wcseo/1.0";$.xmlns.om="http://www.opengis.net/om/2.0";return{parseEOCoverageSetDescription:function(c){var b=WCS.Core.Parse.callParseFunctions("CoverageDescriptions",c.find("wcs|CoverageDescriptions")),c=WCS.Core.Parse.callParseFunctions("DatasetSeriesDescriptions",c.find("wcseo|DatasetSeriesDescriptions"));return{coverageDescriptions:b.coverageDescriptions,datasetSeriesDescriptions:c.datasetSeriesDescriptions}},
parseDatasetSeriesDescriptions:function(c){return{datasetSeriesDescriptions:$.makeArray(c.find("wcseo|DatasetSeriesDescription").map(function(){return WCS.Core.Parse.callParseFunctions("DatasetSeriesDescription",$(this))}))}},parseDatasetSeriesDescription:function(){return{}},parseExtendedCapabilities:function(c){return{contents:{datasetSeries:$.makeArray(c.find("wcs|Contents wcseo|DatasetSeriesSummary").map(function(){var b=$(this);return{datasetSeriesId:b.find("wcseo|DatasetSeriesId").text(),timePeriod:[new Date(b.find("gml|beginPosition").text()),
new Date(b.find("gml|endPosition").text())]}}))}}},parseExtendedCoverageDescription:function(c){$eoMetadata=c.find("wcseo|EOMetadata");return 1==$eoMetadata.size()?($phenomenonTime=$eoMetadata.find("om|phenomenonTime"),{footprint:$.map($eoMetadata.find("om|featureOfInterest gml|posList").text().split(" "),function(b){return parseFloat(b)}),timePeriod:[new Date($phenomenonTime.find("gml|beginPosition").text()),new Date($phenomenonTime.find("gml|endPosition").text())]}):{}}}}();
WCS.Core.Parse.pushParseFunctions({EOCoverageSetDescription:WCS.EO.Parse.parseEOCoverageSetDescription,DatasetSeriesDescriptions:WCS.EO.Parse.parseDatasetSeriesDescriptions,DatasetSeriesDescription:WCS.EO.Parse.parseDatasetSeriesDescription,Capabilities:WCS.EO.Parse.parseExtendedCapabilities,CoverageDescription:WCS.EO.Parse.parseExtendedCoverageDescription});namespace("WCS.Backbone").Model=function(){var c=function(a,b){return!a||!a[b]?null:_.isFunction(a[b])?a[b]():a[b]},b=Backbone.Model.extend({initialize:function(a){a.urlRoot&&(this.urlRoot=a.urlRoot,delete a.urlRoot)},fetch:function(a){a||(a={});a.dataType="xml";Backbone.Model.prototype.fetch.call(this,a)}}),a=Backbone.Collection.extend({fetch:function(a){a||(a={});a.dataType="xml";Backbone.Collection.prototype.fetch.call(this,a)}}),d={};d.Service=b.extend({url:function(){return WCS.Core.KVP.getCapabilitiesURL(c(this,
"urlRoot"))},parse:function(a){return WCS.Core.Parse.parse(a)},fetchAdvertisedCoverages:function(a){var b=this.get("contents"),c=[];b&&(c=_.pluck(b.coverages,"coverageId"));b=new CoverageSet([],{urlRoot:this.urlRoot,coverageIds:c});b.fetch(a);return b}});d.Coverage=b.extend({idAttribute:"coverageId",url:function(){var a=c(this,"urlRoot")||c(this.collection,"url");if(this.id)return WCS.Core.KVP.describeCoverageURL(a,this.id)},parse:function(a){return _.has(a,"coverageId")?a:WCS.Core.Parse.parse(a).coverageDescriptions[0]},
getRangeType:function(){return this.get("rangeType")},getDownloadUrl:function(a){var b=c(this,"urlRoot")||c(this.collection,"urlRoot");return WCS.Core.KVP.getCoverageURL(b,this.id,a)}});d.CoverageSet=a.extend({model:d.Coverage,initialize:function(a,b){this._ids=0==a.length?b.coverageIds||[]:_.pluck(a,id);this.urlRoot=b.urlRoot||this.urlRoot},url:function(){return WCS.Core.KVP.describeCoverageURL(this.urlRoot,this._ids)},parse:function(a){return WCS.Core.Parse.parse(a).coverageDescriptions}});namespace("WCS").EO&&
(d.EOCoverageSet=a.extend({initialize:function(a,b){this.options=b||{};if(this.type=b.type||this.type)delete b.type,"coverages"===this.type?this.model=d.Coverage:"datasetSeries"===this.type&&(this.model=d.DatasetSeries);this.urlRoot=b.urlRoot||this.urlRoot;this.eoid=b.eoid||this.eoid},url:function(){return WCS.EO.KVP.describeEOCoverageSetURL(this.urlRoot,this.eoid,this.options)},parse:function(a){a=WCS.Core.Parse.parse(a);this.coverageDescriptions=a.coverageDescriptions;this.datasetSeriesDescriptions=
a.datasetSeriesDescriptions;switch(this.type){case "coverages":return a.coverageDescriptions;case "datasetSeries":return a.datasetSeriesDescriptions;default:return _.union(a.coverageDescriptions,a.datasetSeriesDescriptions)}}}));return d}();

/* D3.TimeSlider - version 0.0.13 - 2014-03-04
 * See https://github.com/EOX-A/d3.TimeSlider for more information! */
(function(){var a,b=[].slice;a=function(){function a(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=this;for(this.element=a,this.options=null!=b?b:{},this.debug=!0,this.tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),this.bbox=null,this.svg=d3.select(a).append("svg").attr("class","timeslider"),this.useBBox=!1,0===this.svg[0][0].clientWidth&&(d3.select(a).select("svg").append("rect").attr("width","100%").attr("height","100%").attr("opacity","0"),this.useBBox=!0),this.options.width=this.useBBox?this.svg[0][0].getBBox().width:this.options.width=this.svg[0][0].clientWidth,this.options.height=this.useBBox?this.svg[0][0].getBBox().height:this.svg[0][0].clientHeight,(k=this.options).brush||(k.brush={}),(l=this.options.brush).start||(l.start=this.options.start),(m=this.options.brush).end||(m.end=new Date(new Date(this.options.brush.start).setDate(this.options.brush.start.getDate()+3))),(n=this.options).debounce||(n.debounce=50),(o=this.options).ticksize||(o.ticksize=3),this.data={},this.timeouts=[],f=function(a,b,c){return a&&b&&c?(t.timeouts[b]||(t.timeouts[b]=-1),function(){return t.timeouts[b]>-1&&window.clearTimeout(t.timeouts[b]),t.timeouts[b]=window.setTimeout(c,a)}):void 0},d=function(a){return function(b){var c,d;for(d=a.length-1,c=a[d];!c[1](b);)c=a[d--];return c[0](b)}},c=d([[d3.time.format("%Y"),function(){return!0}],[d3.time.format("%B %Y"),function(a){return a.getUTCMonth()}],[d3.time.format("%b %d %Y"),function(a){return 1!==a.getUTCDate()}],[d3.time.format("%b %d %Y "),function(a){return a.getUTCDay()&&1!==a.getUTCDate()}],[d3.time.format("%I %p"),function(a){return a.getUTCHours()}],[d3.time.format("%I:%M"),function(a){return a.getUTCMinutes()}],[d3.time.format(":%S"),function(a){return a.getUTCSeconds()}],[d3.time.format(".%L"),function(a){return a.getUTCMilliseconds()}]]),this.scales={x:d3.time.scale.utc().domain([this.options.domain.start,this.options.domain.end]).range([0,this.options.width]).nice()},this.axis={x:d3.svg.axis().scale(this.scales.x).innerTickSize(this.options.height-13).tickFormat(c)},this.svg.append("g").attr("class","axis").call(this.axis.x),d3.select(this.element).select("g.axis .domain").attr("transform","translate(0, "+(b.height-18)+")"),this.brush=d3.svg.brush().x(this.scales.x).on("brushstart",function(){return t.options.lastZoom={scale:t.options.zoom.scale(),translate:[t.options.zoom.translate()[0],t.options.zoom.translate()[1]]},t.options.zoom.on("zoom",null)}).on("brushend",function(){return t.options.zoom.scale(t.options.lastZoom.scale).translate(t.options.lastZoom.translate).on("zoom",j),t.element.dispatchEvent(new CustomEvent("selectionChanged",{detail:{start:t.brush.extent()[0],end:t.brush.extent()[1]},bubbles:!0,cancelable:!0}))}).extent([this.options.brush.start,this.options.brush.end]),this.svg.append("g").attr("class","brush").call(this.brush).selectAll("rect").attr("height",""+(this.options.height-19)).attr("y",0),this.svg.append("g").attr("class","datasets").attr("width",this.options.width).attr("height",this.options.height).attr("transform","translate(0, "+(b.height-23)+")"),this.drawDataset=function(a){var b;return t.svg.select("g.datasets").append("g").attr("class","dataset").attr("id","dataset-"+a.id),b=t.svg.select("g.datasets #dataset-"+a.id),null==t.options.datasetIndex&&(t.options.datasetIndex=0),t.data[a.id]={index:t.options.datasetIndex++,color:a.color,callback:a.data,points:[],ranges:[]},t.reloadDataset(a.id)},this.updateDataset=function(a){var b,c,d,e;return c=t.svg.select("g.datasets #dataset-"+a),b=t.data[a],d=b.ranges.filter(function(a){return t.scales.x(new Date(a[1]))-t.scales.x(new Date(a[0]))<5}),e=b.ranges.filter(function(a){return t.scales.x(new Date(a[1]))-t.scales.x(new Date(a[0]))>=5}),h(c,e,{index:b.index,color:b.color}),g(c,d.concat(b.points),{index:b.index,color:b.color})},h=function(a,b,c){var d;return a.selectAll("rect").remove(),d=a.selectAll("path").data(b),d.enter().append("rect").attr("x",function(a){return t.scales.x(new Date(a[0]))}).attr("y",-(t.options.ticksize+3)*c.index+-(t.options.ticksize-2)).attr("width",function(a){return t.scales.x(new Date(a[1]))-t.scales.x(new Date(a[0]))}).attr("height",t.options.ticksize-2).attr("stroke",c.color).attr("stroke-width",1).attr("fill",function(a){return a[4]===!1?"transparent":c.color}).on("mouseover",function(a){return a[2]?(t.tooltip.transition().duration(200).style("opacity",.9),t.tooltip.html(a[2]).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")):void 0}).on("mouseout",function(){return t.tooltip.transition().duration(500).style("opacity",0)}).on("click",function(a){return t.element.dispatchEvent(new CustomEvent("coverageselected",{detail:{bbox:a[3],start:a[0],end:a[1]},bubbles:!0,cancelable:!0}))}),d.exit().remove()},g=function(a,b,c){var d;return a.selectAll("circle").remove(),d=a.selectAll("circle").data(b),d.enter().append("circle").attr("cx",function(a){return Array.isArray(a)?t.scales.x(new Date(a[0])):t.scales.x(new Date(a))}).attr("cy",-(t.options.ticksize+3)*c.index+-(t.options.ticksize-2)/2).attr("fill",function(a){return a[4]===!1?"transparent":c.color}).attr("stroke",c.color).attr("stroke-width",1).attr("r",t.options.ticksize/2).on("mouseover",function(a){return a[2]?(t.tooltip.transition().duration(200).style("opacity",.9),t.tooltip.html(a[2]).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")):void 0}).on("mouseout",function(){return t.tooltip.transition().duration(500).style("opacity",0)}).on("click",function(a){return t.element.dispatchEvent(new CustomEvent("coverageselected",{detail:{bbox:a[3],start:a[0],end:a[1]},bubbles:!0,cancelable:!0}))}),d.exit().remove()},this.reloadDataset=function(b){var c;return c=f(t.options.debounce,b,function(){return t.data[b].callback(t.scales.x.domain()[0],t.scales.x.domain()[1],function(b,c){var d,e,f,g,h,i;for(d=t.svg.select("g.datasets #dataset-"+b),g=[],f=[],h=0,i=c.length;i>h;h++)a=c[h],Array.isArray(a)?g.push(a):!(a instanceof Date)&&a.split("/").length>1?(e=a.split("/"),e.pop(),g.push(e)):f.push(a);return t.data[b].ranges=g,t.data[b].points=f,t.updateDataset(b)},t.bbox)}),c()},s=this.options.datasets,p=function(a){return t.drawDataset(a)},q=0,r=s.length;r>q;q++)e=s[q],p(e);this.redraw=function(){var a;t.brush.x(t.scales.x).extent(t.brush.extent()),d3.select(t.element).select("g.axis").call(t.axis.x),d3.select(t.element).select("g.brush").call(t.brush),a=[];for(e in t.data)t.reloadDataset(e),a.push(t.updateDataset(e));return a},i=function(){var a;return a=d3.select(t.element).select("svg.timeslider")[0][0],t.options.width=t.useBBox?a.getBBox().width:a.clientWidth,t.scales.x.range([0,t.options.width]),t.redraw()},d3.select(window).on("resize",i),j=function(){return t.redraw()},this.options.zoom=d3.behavior.zoom().x(this.scales.x).size([this.options.width,this.options.height]).scaleExtent([1,1/0]).on("zoom",j),this.svg.call(this.options.zoom)}return a.prototype.hide=function(){return this.originalDisplay=this.element.style.display,this.element.style.display="none",!0},a.prototype.show=function(){return this.element.style.display=this.originalDisplay,!0},a.prototype.domain=function(){var a,c,d,e;return c=1<=arguments.length?b.call(arguments,0):[],2!==c.length?!1:(d=new Date(c[0]),a=new Date(c[1]),d>a&&(e=[a,d],d=e[0],a=e[1]),this.options.domain.start=d,this.options.domain.end=a,this.scales.x.domain([this.options.domain.start,this.options.domain.end]),this.redraw(),!0)},a.prototype.select=function(){var a,c,d,e;return c=1<=arguments.length?b.call(arguments,0):[],2!==c.length?!1:(d=new Date(c[0]),a=new Date(c[1]),d>a&&(e=[a,d],d=e[0],a=e[1]),d<this.options.start&&(d=this.options.start),a>this.options.end&&(a=this.options.end),d3.select(this.element).select("g.brush").call(this.brush.extent([d,a])),this.element.dispatchEvent(new CustomEvent("selectionChanged",{detail:{start:this.brush.extent()[0],end:this.brush.extent()[1]},bubbles:!0,cancelable:!0})),!0)},a.prototype.addDataset=function(a){return this.drawDataset(a),!0},a.prototype.removeDataset=function(a){var b,c;if(null==this.data[a])return!1;c=this.data[a].index,delete this.data[a],this.options.datasetIndex--,d3.select(this.element).select("g.dataset#dataset-"+a).remove();for(b in this.data)this.data[b].index>c&&(this.data[b].index-=1),this.updateDataset(b);return!0},a.prototype.center=function(){var a;return a=1<=arguments.length?b.call(arguments,0):[],!0},a.prototype.zoom=function(){var a,c,d,e,f=this;return c=1<=arguments.length?b.call(arguments,0):[],d=new Date(c[0]),a=new Date(c[1]),d>a&&(e=[a,d],d=e[0],a=e[1]),d3.transition().duration(750).tween("zoom",function(){var b;return b=d3.interpolate(f.options.zoom.scale(),(f.options.domain.end-f.options.domain.start)/(a-d)),function(a){var c;return c=d3.interpolate(f.options.zoom.translate()[0],f.options.zoom.translate()[0]-f.scales.x(d)),f.options.zoom.scale(b(a)),f.options.zoom.translate([c(a),0]),f.redraw()}}),!0},a.prototype.reset=function(){return this.zoom(this.options.domain.start,this.options.domain.end),!0},a.prototype.updateBBox=function(a,b){return null==this.data[b]?!1:(this.bbox=a,this.reloadDataset(b),!0)},a}(),a.Plugin=function(){function a(){}return a}(),this.TimeSlider=a}).call(this);
language: python

env:
- DOCKER_COMPOSE_VERSION=1.24.0

python:
- '2.7'

services:
- docker

before_install:
- sudo apt-get update

- sudo apt-get install -o Dpkg::Options::="--force-confold" --force-yes -y docker-ce
- docker-compose --version
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-`uname -s`-`uname -m` > docker-compose
- sudo mv docker-compose /usr/local/bin
- docker build . -t eoxserver --add-host=browse:127.0.0.1
- cd autotest

script:
- docker-compose up -d
- docker exec -it $(docker ps --format "{{.ID}}\t{{.Names}}" | grep autotest_autotest_1 | cut -f1) /bin/bash -c " cd /opt/instance/ && ./make_fixtures.sh"
# before_deploy:
# - docker run -it --rm --name build-eoxserver -v "${PWD}/../":/opt/instance --tmpfs /tmp:rw,exec,nosuid,nodev -h browse --add-host=browse:127.0.0.1 eoxserver /bin/bash -c "yum update && yum install -y rpmdevtools && cd /opt/instance/ && python setup.py bdist_rpm"

deploy:
  provider: releases
  api_key:
    secure: QPKKSL6Vc5iN7zt1WtnTZ2CbHX4V5RzpLS9NkR+bUp+fTP24i7twt4J6c2yRjhE3IgSLwj08ESoe3yZW5HqKVB8WhMd8+E/vfkekbllIU74i51hXSlpIS58xNtI8PkT9WE9eYIi90QEbN6es1YjhtBiPYI1WZXg3NC9TscffGfY=
  file_glob: true
  file: ../dist/*.rpm
  skip_cleanup: true
  draft: true
  on:
    tags: true

notifications:
  slack:
    secure: axWg6MRTsvJByFcSG84Birbc3bNFWXnmmA45Rp/4IyBVklI3ytk0WmVx3Qqlf/vz2xfZHdRde4Je/Y+0ufioRY1e3fEl3J/IbcG1CeUcNPn5ghCmn8rJe+ptsFZQYY4uLsX9mWd74Q7xP12kxPQkRKHvpswYtmOhiYxZNEltcIk=
